---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
---

<!-- é¢„åŠ è½½ JSZip æ¨¡å— -->
<script>
  // åœ¨é¡µé¢åŠ è½½æ—¶é¢„åŠ è½½æ¨¡å—
  const preloadJSZip = async () => {
    try {
      console.log("å‡†å¤‡åŠ è½½ JSZip åº“...");
    } catch (error) {
      console.log("JSZip é¢„åŠ è½½å‡†å¤‡å¤±è´¥:", error);
    }
  };

  if (typeof window !== "undefined") {
    preloadJSZip();
  }
</script>

<Layout
  title="åœ¨çº¿è§£å‹ç¼©å·¥å…· - æ•°å¾—å…¶é“"
  description="åœ¨çº¿æ–‡ä»¶è§£å‹å·¥å…·ï¼Œæ”¯æŒåœ¨æµè§ˆå™¨ä¸­ç›´æ¥è§£å‹å¤šç§å‹ç¼©æ–‡ä»¶ï¼Œæ— éœ€å®‰è£…ä»»ä½•è½¯ä»¶"
>
  <Header />

  <main class="main">
    <div class="container">
      <header class="page-header">
        <h1 class="page-title">åœ¨çº¿è§£å‹ç¼©å·¥å…·</h1>
        <p class="page-description">
          æ”¯æŒå¤šç§å‹ç¼©æ ¼å¼çš„åœ¨çº¿è§£å‹å·¥å…·ï¼Œæ— éœ€å®‰è£…ä»»ä½•è½¯ä»¶ï¼Œå®Œå…¨åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ
        </p>
        <div class="format-support" id="format-support">
          <!-- åŠ¨æ€æ˜¾ç¤ºæ”¯æŒçš„æ ¼å¼ -->
        </div>
      </header>

      <div class="extractor-container industrial-border">
        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-section">
          <div class="upload-area" id="upload-area">
            <div class="upload-content">
              <div class="upload-icon">ğŸ“¦</div>
              <h3>é€‰æ‹©æˆ–æ‹–æ‹½å‹ç¼©æ–‡ä»¶</h3>
              <p class="upload-description" id="upload-description">
                æ­£åœ¨åŠ è½½æ”¯æŒæ ¼å¼...
              </p>
              <p class="upload-limit">æœ€å¤§æ”¯æŒ 500MB</p>
              <button class="select-file-btn" id="select-file-btn">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7,10 12,15 17,10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                é€‰æ‹©æ–‡ä»¶
              </button>
            </div>
            <input
              type="file"
              id="file-input"
              accept=".zip,.rar,.tar,.tar.gz,.tgz,.gz,.7z,.xz,.bz2,.lzma,.cab,.iso,.arj,.lzh,.chm"
              hidden
            />
          </div>

          <!-- æ–‡ä»¶ä¿¡æ¯ -->
          <div class="file-info hidden" id="file-info">
            <div class="file-header">
              <div class="file-icon">ğŸ“„</div>
              <div class="file-details">
                <div class="file-name" id="file-name"></div>
                <div class="file-meta">
                  <span class="file-size" id="file-size"></span>
                  <span class="file-type" id="file-type"></span>
                </div>
              </div>
              <button
                class="remove-file-btn"
                id="remove-file-btn"
                title="ç§»é™¤æ–‡ä»¶"
              >
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                >
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- è§£å‹è®¾ç½® -->
        <div class="extract-settings hidden" id="extract-settings">
          <h3 class="settings-title">è§£å‹è®¾ç½®</h3>
          <div class="settings-grid">
            <div class="setting-item">
              <label class="setting-label">
                <input type="checkbox" id="preserve-paths" checked />
                ä¿ç•™ç›®å½•ç»“æ„
              </label>
            </div>
            <div class="setting-item">
              <label class="setting-label">
                <input type="checkbox" id="overwrite-files" />
                è¦†ç›–åŒåæ–‡ä»¶
              </label>
            </div>
          </div>
          <div class="extract-actions">
            <button class="extract-btn" id="extract-btn">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17,8 12,3 7,8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              å¼€å§‹è§£å‹
            </button>
          </div>
        </div>

        <!-- è¿›åº¦æ˜¾ç¤º -->
        <div class="progress-section hidden" id="progress-section">
          <div class="progress-header">
            <h3>è§£å‹è¿›åº¦</h3>
            <span class="progress-percent" id="progress-percent">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          <div class="progress-info">
            <span id="current-file">å‡†å¤‡ä¸­...</span>
          </div>
        </div>

        <!-- æ‰“åŒ…è¿›åº¦æ˜¾ç¤º -->
        <div class="packing-section hidden" id="packing-section">
          <div class="packing-header">
            <h3>æ‰“åŒ…è¿›åº¦</h3>
            <span class="packing-percent" id="packing-percent">0%</span>
          </div>
          <div class="packing-bar">
            <div class="packing-fill" id="packing-fill"></div>
          </div>
          <div class="packing-info">
            <span id="packing-status">å‡†å¤‡ä¸­...</span>
          </div>
        </div>

        <!-- æ–‡ä»¶åˆ—è¡¨ -->
        <div class="file-list hidden" id="file-list">
          <div class="file-list-header">
            <h3>å‹ç¼©åŒ…å†…å®¹</h3>
            <div class="file-actions">
              <button class="action-btn" id="select-all-btn">å…¨é€‰</button>
              <button class="action-btn" id="deselect-all-btn">å–æ¶ˆå…¨é€‰</button>
              <button class="download-btn" id="download-selected-btn">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7,10 12,15 17,10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <span id="download-btn-text">ä¸‹è½½é€‰ä¸­æ–‡ä»¶</span>
              </button>
            </div>
          </div>
          <div class="file-tree" id="file-tree">
            <!-- æ–‡ä»¶æ ‘å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
      </div>

      <!-- æ¶ˆæ¯é€šçŸ¥ -->
      <div class="toast-container" id="toast-container">
        <!-- åŠ¨æ€ç”Ÿæˆçš„é€šçŸ¥å°†æ’å…¥è¿™é‡Œ -->
      </div>

      <!-- ä½¿ç”¨è¯´æ˜ -->
      <section class="instructions-section">
        <div class="instructions-content industrial-border">
          <h2 class="instructions-title">ä½¿ç”¨è¯´æ˜</h2>
          <div class="instructions-grid">
            <div class="instruction-item">
              <div class="instruction-icon">ğŸ“</div>
              <h3>æ”¯æŒæ ¼å¼</h3>
              <p>æ”¯æŒZIPã€RARã€TARã€GZç­‰å¤šç§ä¸»æµå‹ç¼©æ ¼å¼</p>
            </div>
            <div class="instruction-item">
              <div class="instruction-icon">ğŸ”’</div>
              <h3>æœ¬åœ°å¤„ç†</h3>
              <p>æ‰€æœ‰è§£å‹æ“ä½œéƒ½åœ¨æµè§ˆå™¨æœ¬åœ°è¿›è¡Œï¼Œç¡®ä¿æ–‡ä»¶éšç§å®‰å…¨</p>
            </div>
            <div class="instruction-item">
              <div class="instruction-icon">âš¡</div>
              <h3>é«˜æ€§èƒ½</h3>
              <p>åŸºäºJavaScriptå’ŒWebAssemblyæŠ€æœ¯ï¼Œæä¾›é«˜æ•ˆçš„è§£å‹æ€§èƒ½</p>
            </div>
            <div class="instruction-item">
              <div class="instruction-icon">ğŸ“±</div>
              <h3>è·¨å¹³å°</h3>
              <p>æ”¯æŒWindowsã€Macã€Linuxç­‰æ‰€æœ‰ç°ä»£æµè§ˆå™¨</p>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>
</Layout>

<script is:inline>
  class ArchiveExtractor {
    constructor() {
      this.p7zipWorker = null;
      this.currentFile = null;
      this.extractedFiles = new Map();
      this.selectedFiles = new Set();

      this.initElements();
      this.bindEvents();
      this.loadLibarchive().then(() => {
        this.updateSupportedFormatsUI();
      });
    }

    initElements() {
      // ä¸Šä¼ ç›¸å…³å…ƒç´ 
      this.uploadArea = document.getElementById("upload-area");
      this.fileInput = document.getElementById("file-input");
      this.selectFileBtn = document.getElementById("select-file-btn");
      this.fileInfo = document.getElementById("file-info");
      this.fileName = document.getElementById("file-name");
      this.fileSize = document.getElementById("file-size");
      this.fileType = document.getElementById("file-type");
      this.removeFileBtn = document.getElementById("remove-file-btn");

      // è®¾ç½®ç›¸å…³å…ƒç´ 
      this.extractSettings = document.getElementById("extract-settings");
      this.preservePaths = document.getElementById("preserve-paths");
      this.overwriteFiles = document.getElementById("overwrite-files");
      this.extractBtn = document.getElementById("extract-btn");

      // è¿›åº¦ç›¸å…³å…ƒç´ 
      this.progressSection = document.getElementById("progress-section");
      this.progressPercent = document.getElementById("progress-percent");
      this.progressFill = document.getElementById("progress-fill");
      this.currentFile = document.getElementById("current-file");

      // æ‰“åŒ…è¿›åº¦ç›¸å…³å…ƒç´ 
      this.packingSection = document.getElementById("packing-section");
      this.packingPercent = document.getElementById("packing-percent");
      this.packingFill = document.getElementById("packing-fill");
      this.packingStatus = document.getElementById("packing-status");

      // æ–‡ä»¶åˆ—è¡¨ç›¸å…³å…ƒç´ 
      this.fileList = document.getElementById("file-list");
      this.fileTree = document.getElementById("file-tree");
      this.selectAllBtn = document.getElementById("select-all-btn");
      this.deselectAllBtn = document.getElementById("deselect-all-btn");
      this.downloadSelectedBtn = document.getElementById(
        "download-selected-btn"
      );
      this.downloadBtnText = document.getElementById("download-btn-text");
    }

    bindEvents() {
      // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
      this.selectFileBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        this.fileInput.click();
      });
      this.uploadArea.addEventListener("click", (e) => {
        // åªæœ‰å½“ç‚¹å‡»çš„ä¸æ˜¯æŒ‰é’®æˆ–å…¶å­å…ƒç´ æ—¶æ‰è§¦å‘
        if (
          e.target === this.selectFileBtn ||
          this.selectFileBtn.contains(e.target)
        ) {
          return;
        }
        if (e.target === this.fileInput) return;
        this.fileInput.click();
      });
      this.fileInput.addEventListener("click", (e) => e.stopPropagation());
      this.fileInput.addEventListener("change", (e) =>
        this.handleFileSelect(e)
      );

      // æ‹–æ‹½ä¸Šä¼ äº‹ä»¶
      this.uploadArea.addEventListener("dragover", (e) =>
        this.handleDragOver(e)
      );
      this.uploadArea.addEventListener("dragleave", (e) =>
        this.handleDragLeave(e)
      );
      this.uploadArea.addEventListener("drop", (e) => this.handleDrop(e));

      // æ–‡ä»¶æ“ä½œäº‹ä»¶
      this.removeFileBtn.addEventListener("click", () => this.removeFile());
      this.extractBtn.addEventListener("click", () => this.extractArchive());

      // æ–‡ä»¶åˆ—è¡¨æ“ä½œäº‹ä»¶
      this.selectAllBtn.addEventListener("click", () => this.selectAllFiles());
      this.deselectAllBtn.addEventListener("click", () =>
        this.deselectAllFiles()
      );
      this.downloadSelectedBtn.addEventListener("click", () =>
        this.downloadSelectedFiles()
      );
    }

    async loadLibarchive() {
      try {
        await this.loadLibarchiveWasm();
        console.log("è§£å‹åº“åŠ è½½æˆåŠŸ");

        // æ˜¾ç¤ºåŠ è½½æˆåŠŸçš„æ ¼å¼
        const supportedFormats = this.getSupportedFormats();
        if (supportedFormats.types.length > 0) {
          this.showInfo(
            `è§£å‹åº“åŠ è½½å®Œæˆï¼Œæ”¯æŒ ${supportedFormats.types.join("ã€")} æ ¼å¼`,
            3000
          );
        } else {
          this.showWarning("éƒ¨åˆ†è§£å‹åº“åŠ è½½å¤±è´¥ï¼ŒåŠŸèƒ½å¯èƒ½å—é™");
        }
      } catch (error) {
        console.error("è§£å‹åº“åŠ è½½å¤±è´¥:", error);
        this.showError("è§£å‹åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
      }
    }

    async loadLibarchiveWasm() {
      try {
        // åªåˆå§‹åŒ–p7zip-wasm workerï¼Œæ”¯æŒæ‰€æœ‰æ ¼å¼
        await this.initP7zipWorker();

        console.log("è§£å‹åº“åŠ è½½å®Œæˆ:", {
          P7ZIP: !!this.p7zipWorker,
          "æ”¯æŒæ ¼å¼": "ZIP, RAR, 7Z, TAR, GZ, XZ, BZ2, LZMA ç­‰"
        });

        return Promise.resolve();
      } catch (error) {
        console.error("è§£å‹åº“åŠ è½½å¤±è´¥:", error);
        return Promise.resolve();
      }
    }

    async loadJSZip() {
      if (window.JSZip) return Promise.resolve();
      
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js';
        script.onload = () => resolve();
        script.onerror = () => reject(new Error('JSZip åŠ è½½å¤±è´¥'));
        document.head.appendChild(script);
      });
    }

    async initP7zipWorker() {
      try {
        // åˆ›å»ºp7zip worker
        this.p7zipWorker = new Worker('/tools/p7zip-wasm/worker.js');
        
        // ç­‰å¾…workerå‡†å¤‡å°±ç»ª
        return new Promise((resolve, reject) => {
          const timeout = setTimeout(() => {
            reject(new Error('Worker åˆå§‹åŒ–è¶…æ—¶'));
          }, 10000);

          this.p7zipWorker.onmessage = (e) => {
            const data = e.data;
            if (data.t === 'ready') {
              clearTimeout(timeout);
              console.log('P7zip Worker å‡†å¤‡å°±ç»ª');
              resolve();
            } else if (data.t === 'error') {
              clearTimeout(timeout);
              reject(new Error(data.msg));
            }
          };

          this.p7zipWorker.onerror = (error) => {
            clearTimeout(timeout);
            reject(error);
          };
        });
      } catch (error) {
        console.error('P7zip Worker åˆå§‹åŒ–å¤±è´¥:', error);
        this.p7zipWorker = null;
      }
    }


    handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        // æ¸…é™¤ä¹‹å‰çš„è§£å‹ç»“æœ
        this.clearPreviousResults();
        this.processFile(file);
      }
    }

    handleDragOver(event) {
      event.preventDefault();
      this.uploadArea.classList.add("drag-over");
    }

    handleDragLeave(event) {
      event.preventDefault();
      this.uploadArea.classList.remove("drag-over");
    }

    handleDrop(event) {
      event.preventDefault();
      this.uploadArea.classList.remove("drag-over");

      const files = event.dataTransfer.files;
      if (files.length > 0) {
        // æ¸…é™¤ä¹‹å‰çš„è§£å‹ç»“æœ
        this.clearPreviousResults();
        this.processFile(files[0]);
      }
    }

    processFile(file) {
      console.log("å¼€å§‹å¤„ç†æ–‡ä»¶:", file.name, "å¤§å°:", file.size);
      
      // æ£€æŸ¥æ–‡ä»¶å¤§å° (500MBé™åˆ¶)
      if (file.size > 500 * 1024 * 1024) {
        this.showError("æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 500MB");
        return;
      }

      // æ£€æŸ¥æ–‡ä»¶æ ¼å¼
      const fileExtension = file.name.toLowerCase().split(".").pop();
      const supportedFormats = this.getSupportedFormats();
      
      console.log("æ–‡ä»¶æ‰©å±•å:", fileExtension);
      console.log("æ”¯æŒçš„æ ¼å¼:", supportedFormats);

      if (!supportedFormats.extensions.includes(fileExtension)) {
        console.log("æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒï¼Œå½“å‰æ”¯æŒ:", supportedFormats.extensions);
        this.showError(
          `ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ã€‚æ”¯æŒçš„æ ¼å¼ï¼š${supportedFormats.extensions.join(", ").toUpperCase()}`
        );
        return;
      }

      console.log("æ–‡ä»¶æ ¼å¼éªŒè¯é€šè¿‡ï¼Œå¼€å§‹æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯");
      this.currentFile = file;
      this.showFileInfo(file);
      this.extractSettings.classList.remove("hidden");
    }

    showFileInfo(file) {
      this.fileName.textContent = file.name;
      this.fileSize.textContent = this.formatFileSize(file.size);
      this.fileType.textContent = file.type || "æœªçŸ¥ç±»å‹";
      this.fileInfo.classList.remove("hidden");
    }

    clearPreviousResults() {
      // æ¸…é™¤è§£å‹ç›¸å…³çš„ç»“æœï¼Œä½†ä¿ç•™æ–‡ä»¶ä¿¡æ¯
      this.extractedFiles.clear();
      this.selectedFiles.clear();
      this.progressSection.classList.add("hidden");
      this.packingSection.classList.add("hidden");
      this.fileList.classList.add("hidden");
    }

    removeFile() {
      this.currentFile = null;
      this.extractedFiles.clear();
      this.selectedFiles.clear();
      this.fileInfo.classList.add("hidden");
      this.extractSettings.classList.add("hidden");
      this.progressSection.classList.add("hidden");
      this.packingSection.classList.add("hidden");
      this.fileList.classList.add("hidden");
      this.fileInput.value = "";
    }

    async extractArchive() {
      if (!this.currentFile) {
        this.showError("è¯·å…ˆé€‰æ‹©æ–‡ä»¶");
        return;
      }

      if (!this.p7zipWorker) {
        this.showError("è§£å‹åº“æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨å€™é‡è¯•");
        return;
      }

      try {
        this.extractBtn.disabled = true;
        this.progressSection.classList.remove("hidden");
        this.updateProgress(0, "å‡†å¤‡è§£å‹...");

        const arrayBuffer = await this.currentFile.arrayBuffer();
        const uint8Array = new Uint8Array(arrayBuffer);

        // ä½¿ç”¨ libarchive è§£å‹
        await this.extractWithLibarchive(uint8Array);
      } catch (error) {
        console.error("è§£å‹å¤±è´¥:", error);
        this.showError("è§£å‹å¤±è´¥: " + error.message);
      } finally {
        this.extractBtn.disabled = false;
      }
    }

    getSupportedFormats() {
      const formats = {
        extensions: [],
        types: [],
      };

      // p7zip-wasm æ”¯æŒå‡ ä¹æ‰€æœ‰å¸¸è§çš„å‹ç¼©æ ¼å¼
      if (this.p7zipWorker) {
        formats.extensions.push(
          "zip", "rar", "7z", "tar", "tar.gz", "tgz", "gz", 
          "xz", "bz2", "lzma", "cab", "iso", "arj", "lzh", "chm"
        );
        formats.types.push(
          "ZIP", "RAR", "7Z", "TAR", "GZ", "XZ", "BZ2", "LZMA", 
          "CAB", "ISO", "ARJ", "LZH", "CHM"
        );
      }
      
      // è®°å½•è°ƒè¯•ä¿¡æ¯
      console.log("getSupportedFormatsè°ƒç”¨:", {
        p7zipWorker: !!this.p7zipWorker,
        supportedCount: formats.extensions.length
      });

      return formats;
    }

    updateSupportedFormatsUI() {
      const supportedFormats = this.getSupportedFormats();

      // æ›´æ–°æ ¼å¼æ”¯æŒæ˜¾ç¤º
      const formatSupport = document.getElementById("format-support");
      if (formatSupport) {
        formatSupport.innerHTML = "";
        supportedFormats.types.forEach((type) => {
          const item = document.createElement("div");
          item.className = "format-item";
          item.textContent = type;
          formatSupport.appendChild(item);
        });
      }

      // æ›´æ–°ä¸Šä¼ æè¿°
      const uploadDescription = document.getElementById("upload-description");
      if (uploadDescription) {
        if (supportedFormats.extensions.length > 0) {
          uploadDescription.textContent = `æ”¯æŒ ${supportedFormats.types.join("ã€")} æ ¼å¼æ–‡ä»¶`;
        } else {
          uploadDescription.textContent = "æ­£åœ¨åŠ è½½è§£å‹åº“...";
        }
      }

      // æ›´æ–°ä½¿ç”¨è¯´æ˜
      const instructionText = document.querySelector(".instruction-item p");
      if (instructionText && supportedFormats.types.length > 0) {
        instructionText.textContent = `æ”¯æŒ ${supportedFormats.types.join("ã€")} ç­‰å¤šç§å‹ç¼©æ ¼å¼`;
      }
    }

    detectFileFormat(file) {
      const extension = file.name.toLowerCase().split(".").pop();
      const name = file.name.toLowerCase();

      // æ£€æŸ¥æ˜¯å¦æ˜¯ p7zip æ”¯æŒçš„æ ¼å¼
      const supportedFormats = this.getSupportedFormats();
      const isSupported = supportedFormats.extensions.some(ext => {
        if (ext.includes('.')) {
          // å¤„ç†å¤åˆæ‰©å±•åå¦‚ tar.gz
          return name.endsWith('.' + ext);
        } else {
          // å¤„ç†å•ä¸€æ‰©å±•å
          return extension === ext;
        }
      });

      if (isSupported) {
        return "p7zip-format"; // æ‰€æœ‰æ”¯æŒçš„æ ¼å¼éƒ½é€šè¿‡p7zip-wasmå¤„ç†
      }

      return "unknown";
    }

    async extractWithLibarchive(data) {
      this.updateProgress(5, "æ­£åœ¨åˆå§‹åŒ–è§£å‹å™¨...");

      const format = this.detectFileFormat(this.currentFile);
      console.log("æ£€æµ‹åˆ°æ–‡ä»¶æ ¼å¼:", format);

      if (format === "p7zip-format") {
        await this.extractWithP7zip(data);
      } else {
        throw new Error(`ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${this.currentFile.name}`);
      }
    }


    async extractWithP7zip(data) {
      this.updateProgress(10, "æ­£åœ¨è§£æå‹ç¼©æ–‡ä»¶...");

      if (!this.p7zipWorker) {
        // æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè§£å†³æ–¹æ¡ˆ
        this.showError("è§£å‹åº“åŠ è½½å¤±è´¥ã€‚å»ºè®®ï¼š\n1. åˆ·æ–°é¡µé¢é‡è¯•\n2. å°†æ–‡ä»¶è½¬æ¢ä¸ºZIPæ ¼å¼\n3. ä½¿ç”¨æ¡Œé¢è§£å‹è½¯ä»¶");
        throw new Error("è§£å‹åº“æœªåŠ è½½ï¼Œè¯·å°è¯•å…¶ä»–æ ¼å¼æˆ–å·¥å…·");
      }

      try {
        this.updateProgress(20, "æ­£åœ¨åˆå§‹åŒ–p7zip-wasm...");
        
        // åˆ›å»ºæ–‡ä»¶ Blob
        const fileBlob = new Blob([data], { type: 'application/octet-stream' });
        fileBlob.name = this.currentFile.name;
        
        console.log("å¼€å§‹ä½¿ç”¨p7zip-wasmè§£å‹æ–‡ä»¶:", this.currentFile.name);
        
        // æ‰“å¼€å‹ç¼©æ–‡ä»¶
        const openResult = await this.sendWorkerMessage({
          t: 'open',
          blob: fileBlob
        });
        
        if (openResult.t === 'error') {
          throw new Error(openResult.msg);
        }
        
        this.updateProgress(40, "æ­£åœ¨è¯»å–æ–‡ä»¶åˆ—è¡¨...");
        
        // è·å–æ–‡ä»¶åˆ—è¡¨
        const fileList = openResult.state.fileList;
        console.log("å‹ç¼©æ–‡ä»¶åŒ…å«", fileList.length, "ä¸ªæ¡ç›®");
        
        this.updateProgress(50, "æ­£åœ¨è§£å‹æ–‡ä»¶...");
        
        // è§£å‹æ‰€æœ‰æ–‡ä»¶
        const entries = [];
        for (let i = 0; i < fileList.length; i++) {
          const file = fileList[i];
          const progress = 50 + (i / fileList.length) * 40;
          this.updateProgress(progress, `æ­£åœ¨è§£å‹: ${file.path}`);
          
          // è·³è¿‡ç›®å½•
          if (file.type & 1) {
            entries.push({
              name: file.path,
              size: 0,
              isDirectory: true,
              data: null,
            });
            continue;
          }
          
          // è§£å‹å•ä¸ªæ–‡ä»¶
          try {
            const extractResult = await this.sendWorkerMessage({
              t: 'extract',
              idx: file.idx,
              name: file.path
            });
            
            if (extractResult.t === 'extracted') {
              const blob = extractResult.blob;
              const arrayBuffer = await blob.arrayBuffer();
              const uint8Array = new Uint8Array(arrayBuffer);
              
              entries.push({
                name: file.path,
                size: file.size,
                isDirectory: false,
                data: uint8Array,
              });
            } else if (extractResult.t === 'error') {
              console.error("è§£å‹æ–‡ä»¶å¤±è´¥:", file.path, extractResult.msg);
            }
          } catch (extractError) {
            console.error("è§£å‹æ–‡ä»¶å¼‚å¸¸:", file.path, extractError);
          }
        }
        
        this.updateProgress(90, "æ­£åœ¨å¤„ç†æ–‡ä»¶åˆ—è¡¨...");
        
        console.log(`æˆåŠŸè§£æ ${entries.length} ä¸ªæ–‡ä»¶æ¡ç›®`);
        
        await this.processExtractedEntries(entries);
      } catch (error) {
        console.error("p7zip-wasm è§£å‹å¤±è´¥:", error);
        
        if (error.message.includes('Bad archive') || error.message.includes('Invalid format')) {
          throw new Error("ä¸æ˜¯æœ‰æ•ˆçš„å‹ç¼©æ–‡ä»¶æˆ–æ–‡ä»¶å·²æŸå");
        } else if (error.message.includes('password') || error.message.includes('encrypted')) {
          throw new Error("æ–‡ä»¶å·²åŠ å¯†ï¼Œæš‚ä¸æ”¯æŒåŠ å¯†æ–‡ä»¶è§£å‹");
        } else if (error.message.includes('not supported')) {
          throw new Error("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼æˆ–ç‰ˆæœ¬");
        } else {
          throw new Error("è§£å‹å¤±è´¥: " + error.message);
        }
      }
    }

    // Worker æ¶ˆæ¯é€šä¿¡å¸®åŠ©æ–¹æ³•
    sendWorkerMessage(message) {
      return new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
          reject(new Error('Worker æ“ä½œè¶…æ—¶'));
        }, 30000);

        const handleMessage = (e) => {
          const data = e.data;
          if (data.t === 'opened' || data.t === 'extracted' || data.t === 'done') {
            clearTimeout(timeout);
            this.p7zipWorker.removeEventListener('message', handleMessage);
            resolve(data);
          } else if (data.t === 'error') {
            clearTimeout(timeout);
            this.p7zipWorker.removeEventListener('message', handleMessage);
            reject(new Error(data.msg));
          }
        };

        this.p7zipWorker.addEventListener('message', handleMessage);
        this.p7zipWorker.postMessage(message);
      });
    }


    async processExtractedEntries(entries) {
      this.updateProgress(70, "æ­£åœ¨å¤„ç†è§£å‹ç»“æœ...");

      for (let i = 0; i < entries.length; i++) {
        const entry = entries[i];
        const progress = 70 + (i / entries.length) * 25;

        this.updateProgress(progress, `æ­£åœ¨å¤„ç†: ${entry.name}`);

        this.extractedFiles.set(entry.name, entry);
      }

      this.updateProgress(100, "è§£å‹å®Œæˆ");
      this.showFileList();

      // æ˜¾ç¤ºè§£å‹æˆåŠŸæ¶ˆæ¯
      const fileCount = entries.filter((e) => !e.isDirectory).length;
      const dirCount = entries.filter((e) => e.isDirectory).length;
      let message = `è§£å‹å®Œæˆï¼å…± ${fileCount} ä¸ªæ–‡ä»¶`;
      if (dirCount > 0) {
        message += `ï¼Œ${dirCount} ä¸ªæ–‡ä»¶å¤¹`;
      }
      this.showSuccess(message);
    }

    showFileList() {
      this.fileList.classList.remove("hidden");
      this.fileTree.innerHTML = "";

      const files = Array.from(this.extractedFiles.values());
      const tree = this.buildFileTree(files);
      this.renderFileTree(tree, this.fileTree);

      // é»˜è®¤é€‰ä¸­æ‰€æœ‰éç›®å½•æ–‡ä»¶
      this.selectedFiles.clear();
      files.forEach((file) => {
        if (!file.isDirectory) {
          this.selectedFiles.add(file.name);
        }
      });
      this.updateFileCheckboxes();
    }

    buildFileTree(files) {
      const tree = {};

      files.forEach((file) => {
        const parts = file.name.split("/").filter((part) => part);
        let current = tree;

        parts.forEach((part, index) => {
          if (!current[part]) {
            current[part] = {
              name: part,
              fullPath: parts.slice(0, index + 1).join("/"),
              isDirectory: index < parts.length - 1 || file.isDirectory,
              children: {},
              file: index === parts.length - 1 ? file : null,
            };
          }
          current = current[part].children;
        });
      });

      return tree;
    }

    renderFileTree(tree, container, level = 0) {
      Object.values(tree).forEach((node) => {
        const div = document.createElement("div");
        div.className = "file-tree-item";
        div.style.paddingLeft = level * 20 + "px";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "file-checkbox";
        checkbox.value = node.fullPath;
        checkbox.checked = this.selectedFiles.has(node.fullPath);

        if (!node.isDirectory) {
          checkbox.addEventListener("change", (e) => {
            if (e.target.checked) {
              this.selectedFiles.add(node.fullPath);
            } else {
              this.selectedFiles.delete(node.fullPath);
            }
            this.updateDownloadButtonText();
          });
        } else {
          checkbox.disabled = true;
        }

        const icon = document.createElement("span");
        icon.className = "file-icon";
        icon.textContent = node.isDirectory ? "ğŸ“" : "ğŸ“„";

        const name = document.createElement("span");
        name.className = "file-name";
        name.textContent = node.name;

        const size = document.createElement("span");
        size.className = "file-size";
        if (node.file && !node.isDirectory) {
          size.textContent = this.formatFileSize(node.file.size);
        }

        div.appendChild(checkbox);
        div.appendChild(icon);
        div.appendChild(name);
        div.appendChild(size);

        container.appendChild(div);

        if (Object.keys(node.children).length > 0) {
          this.renderFileTree(node.children, container, level + 1);
        }
      });
    }

    selectAllFiles() {
      this.selectedFiles.clear();
      this.extractedFiles.forEach((file, path) => {
        if (!file.isDirectory) {
          this.selectedFiles.add(path);
        }
      });
      this.updateFileCheckboxes();
    }

    deselectAllFiles() {
      this.selectedFiles.clear();
      this.updateFileCheckboxes();
    }

    updateFileCheckboxes() {
      const checkboxes = this.fileTree.querySelectorAll(".file-checkbox");
      checkboxes.forEach((checkbox) => {
        checkbox.checked = this.selectedFiles.has(checkbox.value);
      });
      this.updateDownloadButtonText();
    }

    updateDownloadButtonText() {
      const selectedCount = Array.from(this.selectedFiles).filter((path) => {
        const file = this.extractedFiles.get(path);
        return file && !file.isDirectory && file.data;
      }).length;

      if (selectedCount === 0) {
        this.downloadBtnText.textContent = "ä¸‹è½½é€‰ä¸­æ–‡ä»¶";
      } else if (selectedCount === 1) {
        this.downloadBtnText.textContent = "ä¸‹è½½æ–‡ä»¶";
      } else {
        this.downloadBtnText.textContent = `æ‰“åŒ…ä¸‹è½½ (${selectedCount} ä¸ªæ–‡ä»¶)`;
      }
    }

    async downloadSelectedFiles() {
      if (this.selectedFiles.size === 0) {
        this.showError("è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„æ–‡ä»¶");
        return;
      }

      // è¿‡æ»¤æ‰ç›®å½•ï¼Œåªä¸‹è½½æ–‡ä»¶
      const fileOnlyPaths = Array.from(this.selectedFiles).filter((path) => {
        const file = this.extractedFiles.get(path);
        return file && !file.isDirectory && file.data;
      });

      if (fileOnlyPaths.length === 0) {
        this.showError("æœªé€‰æ‹©æœ‰æ•ˆçš„æ–‡ä»¶");
        return;
      }

      try {
        if (fileOnlyPaths.length === 1) {
          // å•æ–‡ä»¶ä¸‹è½½
          const file = this.extractedFiles.get(fileOnlyPaths[0]);
          const fileName = this.getFileName(file.name);
          this.downloadFile(file.data, fileName);
          this.showSuccess(`æ–‡ä»¶ "${fileName}" ä¸‹è½½æˆåŠŸï¼`);
        } else {
          // å¤šæ–‡ä»¶æ‰“åŒ…ä¸‹è½½
          console.log(`å¼€å§‹æ‰“åŒ…ä¸‹è½½ ${fileOnlyPaths.length} ä¸ªæ–‡ä»¶`);
          await this.downloadMultipleFiles();
        }
      } catch (error) {
        console.error("ä¸‹è½½å¤±è´¥:", error);
        this.showError("ä¸‹è½½å¤±è´¥: " + error.message);
      }
    }

    getFileName(fullPath) {
      // ä»å®Œæ•´è·¯å¾„ä¸­æå–æ–‡ä»¶å
      return fullPath.split("/").pop() || fullPath;
    }

    downloadFile(data, filename) {
      const blob = new Blob([data]);
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    async downloadMultipleFiles() {
      // åŠ è½½ JSZip ç”¨äºå¤šæ–‡ä»¶æ‰“åŒ…
      if (!window.JSZip) {
        try {
          await this.loadJSZip();
        } catch (error) {
          this.showError("å¤šæ–‡ä»¶æ‰“åŒ…éœ€è¦ JSZip åº“æ”¯æŒ");
          return;
        }
      }

      try {
        // æ˜¾ç¤ºæ‰“åŒ…è¿›åº¦
        this.showPackingProgress(true);
        this.updatePackingProgress(0, "å‡†å¤‡æ‰“åŒ…æ–‡ä»¶...");

        const JSZip = window.JSZip;
        const zip = new JSZip();

        // åªè·å–æœ‰æ•ˆçš„æ–‡ä»¶ï¼ˆéç›®å½•ä¸”æœ‰æ•°æ®ï¼‰
        const validFiles = Array.from(this.selectedFiles)
          .map((path) => this.extractedFiles.get(path))
          .filter((file) => file && !file.isDirectory && file.data);

        if (validFiles.length === 0) {
          throw new Error("æ²¡æœ‰æœ‰æ•ˆçš„æ–‡ä»¶å¯ä»¥æ‰“åŒ…");
        }

        let processedCount = 0;

        // æ·»åŠ é€‰ä¸­çš„æ–‡ä»¶åˆ°ZIP
        for (const file of validFiles) {
          // ä¿æŒåŸæœ‰çš„ç›®å½•ç»“æ„
          zip.file(file.name, file.data);
          processedCount++;

          const progress = (processedCount / validFiles.length) * 70;
          this.updatePackingProgress(
            progress,
            `æ­£åœ¨æ·»åŠ : ${this.getFileName(file.name)}`
          );
        }

        this.updatePackingProgress(75, "æ­£åœ¨ç”ŸæˆZIPæ–‡ä»¶...");

        // ç”ŸæˆZIPæ–‡ä»¶
        const zipBlob = await zip.generateAsync(
          {
            type: "blob",
            compression: "DEFLATE",
            compressionOptions: {
              level: 6,
            },
          },
          (metadata) => {
            // æ˜¾ç¤ºZIPç”Ÿæˆè¿›åº¦
            const progress = 75 + metadata.percent * 0.25;
            this.updatePackingProgress(
              progress,
              `å‹ç¼©è¿›åº¦: ${Math.round(metadata.percent)}%`
            );
          }
        );

        this.updatePackingProgress(100, "æ‰“åŒ…å®Œæˆ");

        // ç”Ÿæˆä¸‹è½½æ–‡ä»¶å
        const originalFileName = this.currentFile.name.replace(/\.[^/.]+$/, "");
        const downloadFileName = `${originalFileName}_extracted_files.zip`;

        // ä¸‹è½½æ‰“åŒ…åçš„æ–‡ä»¶
        this.downloadFile(zipBlob, downloadFileName);

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å¹¶éšè—è¿›åº¦æ¡
        setTimeout(() => {
          this.showPackingProgress(false);
          this.showSuccess(
            `æˆåŠŸæ‰“åŒ…ä¸‹è½½ ${validFiles.length} ä¸ªæ–‡ä»¶ï¼æ–‡ä»¶åï¼š${downloadFileName}`
          );
        }, 1000);
      } catch (error) {
        console.error("å¤šæ–‡ä»¶æ‰“åŒ…å¤±è´¥:", error);
        this.showError("æ–‡ä»¶æ‰“åŒ…å¤±è´¥: " + error.message);
        this.showPackingProgress(false);
      }
    }

    updateProgress(percent, message) {
      this.progressPercent.textContent = Math.round(percent) + "%";
      this.progressFill.style.width = percent + "%";
      this.currentFile.textContent = message;
    }

    showPackingProgress(show) {
      if (show) {
        this.packingSection.classList.remove("hidden");
      } else {
        this.packingSection.classList.add("hidden");
      }
    }

    updatePackingProgress(percent, message) {
      this.packingPercent.textContent = Math.round(percent) + "%";
      this.packingFill.style.width = percent + "%";
      this.packingStatus.textContent = message;
    }

    formatFileSize(bytes) {
      if (bytes === 0) return "0 Bytes";
      const k = 1024;
      const sizes = ["Bytes", "KB", "MB", "GB"];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
    }

    showToast(message, type = "info", duration = 4000) {
      const container = document.getElementById("toast-container");
      if (!container) return;

      // åˆ›å»ºé€šçŸ¥å…ƒç´ 
      const toast = document.createElement("div");
      toast.className = `toast toast-${type}`;

      // å›¾æ ‡æ˜ å°„
      const icons = {
        success: "âœ…",
        error: "âŒ",
        warning: "âš ï¸",
        info: "â„¹ï¸",
      };

      toast.innerHTML = `
        <div class="toast-icon">${icons[type] || icons.info}</div>
        <div class="toast-message">${message}</div>
        <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
      `;

      // æ·»åŠ åˆ°å®¹å™¨
      container.appendChild(toast);

      // æ·»åŠ è¿›å…¥åŠ¨ç”»
      setTimeout(() => {
        toast.classList.add("toast-show");
      }, 10);

      // è‡ªåŠ¨ç§»é™¤
      setTimeout(() => {
        if (toast.parentElement) {
          toast.classList.remove("toast-show");
          setTimeout(() => {
            if (toast.parentElement) {
              toast.remove();
            }
          }, 300);
        }
      }, duration);
    }

    showError(message, duration = 5000) {
      this.showToast(message, "error", duration);
    }

    showSuccess(message, duration = 4000) {
      this.showToast(message, "success", duration);
    }

    showWarning(message, duration = 4000) {
      this.showToast(message, "warning", duration);
    }

    showInfo(message, duration = 3000) {
      this.showToast(message, "info", duration);
    }
  }

  // åˆå§‹åŒ–åº”ç”¨
  document.addEventListener("DOMContentLoaded", () => {
    new ArchiveExtractor();
  });
</script>

<style>
  .main {
    min-height: calc(100vh - 80px);
    padding: 2rem 0;
  }

  .page-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .page-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    font-family: var(--font-mono);
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .page-description {
    font-size: 1.125rem;
    color: var(--color-secondary);
    margin-bottom: 2rem;
    font-family: var(--font-sans);
  }

  .format-support {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .format-item {
    padding: 0.25rem 0.5rem;
    background-color: var(--color-accent);
    color: var(--color-bg);
    font-family: var(--font-mono);
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-radius: 4px;
  }

  .extractor-container {
    background-color: var(--color-card);
    padding: 2rem;
    margin-bottom: 3rem;
  }

  /* ä¸Šä¼ åŒºåŸŸ */
  .upload-area {
    border: 2px dashed var(--color-border);
    border-radius: 8px;
    padding: 3rem 2rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .upload-area:hover,
  .upload-area.drag-over {
    border-color: var(--color-accent);
    background-color: var(--color-code-bg);
  }

  .upload-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .upload-content h3 {
    font-family: var(--font-mono);
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .upload-description {
    color: var(--color-secondary);
    margin-bottom: 0.5rem;
    font-family: var(--font-sans);
  }

  .upload-limit {
    color: var(--color-muted);
    font-size: 0.875rem;
    margin-bottom: 1.5rem;
    font-family: var(--font-mono);
  }

  .select-file-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background-color: var(--color-accent);
    color: var(--color-bg);
    border: none;
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .select-file-btn:hover {
    background-color: var(--color-text);
    transform: translateY(-1px);
  }

  /* æ–‡ä»¶ä¿¡æ¯ */
  .file-info {
    margin-top: 2rem;
    padding: 1rem;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    background-color: var(--color-code-bg);
  }

  .file-header {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .file-icon {
    font-size: 2rem;
  }

  .file-details {
    flex: 1;
  }

  .file-name {
    font-family: var(--font-mono);
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 0.25rem;
  }

  .file-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
    color: var(--color-secondary);
  }

  .remove-file-btn {
    padding: 0.5rem;
    background: none;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    color: var(--color-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .remove-file-btn:hover {
    color: var(--color-text);
    border-color: var(--color-text);
  }

  /* è§£å‹è®¾ç½® */
  .extract-settings {
    margin-top: 2rem;
  }

  .settings-title {
    font-family: var(--font-mono);
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .setting-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: var(--font-sans);
    font-size: 0.9rem;
    cursor: pointer;
  }

  .setting-label input[type="checkbox"] {
    margin: 0;
  }

  .extract-actions {
    text-align: center;
  }

  .extract-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 2rem;
    background-color: var(--color-accent);
    color: var(--color-bg);
    border: none;
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .extract-btn:hover:not(:disabled) {
    background-color: var(--color-text);
    transform: translateY(-1px);
  }

  .extract-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* è¿›åº¦æ˜¾ç¤º */
  .progress-section,
  .packing-section {
    margin-top: 2rem;
    padding: 1.5rem;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    background-color: var(--color-code-bg);
  }

  .progress-header,
  .packing-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .progress-header h3,
  .packing-header h3 {
    font-family: var(--font-mono);
    font-size: 1rem;
    font-weight: 700;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .progress-percent,
  .packing-percent {
    font-family: var(--font-mono);
    font-weight: 700;
    color: var(--color-accent);
  }

  .progress-bar,
  .packing-bar {
    width: 100%;
    height: 8px;
    background-color: var(--color-border);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.5rem;
  }

  .progress-fill,
  .packing-fill {
    height: 100%;
    background-color: var(--color-accent);
    transition: width 0.3s ease;
    width: 0%;
  }

  .progress-info,
  .packing-info {
    font-size: 0.875rem;
    color: var(--color-secondary);
    font-family: var(--font-mono);
  }

  /* æ‰“åŒ…è¿›åº¦ç‰¹æ®Šæ ·å¼ */
  .packing-section {
    border-color: var(--color-accent);
  }

  .packing-fill {
    background: linear-gradient(90deg, var(--color-accent), #4ade80);
  }

  /* æ–‡ä»¶åˆ—è¡¨ */
  .file-list {
    margin-top: 2rem;
  }

  .file-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    gap: 1rem;
  }

  .file-list-header h3 {
    font-family: var(--font-mono);
    font-size: 1rem;
    font-weight: 700;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .file-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  .action-btn {
    padding: 0.5rem 1rem;
    background: none;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .action-btn:hover {
    background-color: var(--color-code-bg);
    border-color: var(--color-text);
  }

  .download-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background-color: var(--color-accent);
    color: var(--color-bg);
    border: none;
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .download-btn:hover {
    background-color: var(--color-text);
    transform: translateY(-1px);
  }

  .file-tree {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    background-color: var(--color-code-bg);
  }

  .file-tree-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-bottom: 1px solid var(--color-border);
    font-family: var(--font-mono);
    font-size: 0.875rem;
  }

  .file-tree-item:last-child {
    border-bottom: none;
  }

  .file-tree-item:hover {
    background-color: var(--color-bg);
  }

  .file-checkbox {
    margin: 0;
  }

  .file-tree-item .file-icon {
    font-size: 1rem;
  }

  .file-tree-item .file-name {
    flex: 1;
  }

  .file-tree-item .file-size {
    color: var(--color-secondary);
    font-size: 0.75rem;
  }

  /* ä½¿ç”¨è¯´æ˜ */
  .instructions-section {
    margin-bottom: 2rem;
  }

  .instructions-content {
    background-color: var(--color-card);
    padding: 2rem;
  }

  .instructions-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 2rem;
    text-align: center;
    font-family: var(--font-mono);
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--color-accent);
  }

  .instructions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
  }

  .instruction-item {
    text-align: center;
  }

  .instruction-icon {
    font-size: 2rem;
    margin-bottom: 1rem;
  }

  .instruction-item h3 {
    font-family: var(--font-mono);
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .instruction-item p {
    color: var(--color-secondary);
    font-size: 0.9rem;
    line-height: 1.5;
    margin: 0;
    font-family: var(--font-sans);
  }

  .hidden {
    display: none !important;
  }

  /* æ¶ˆæ¯é€šçŸ¥æ ·å¼ */
  .toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .toast {
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 300px;
    max-width: 500px;
    padding: 16px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    font-family: var(--font-sans);
    font-size: 0.9rem;
    line-height: 1.4;
    backdrop-filter: blur(10px);
    transform: translateX(100%);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .toast-show {
    transform: translateX(0);
    opacity: 1;
  }

  .toast-success {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border-left: 4px solid #34d399;
  }

  .toast-error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    border-left: 4px solid #f87171;
  }

  .toast-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
    border-left: 4px solid #fbbf24;
  }

  .toast-info {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border-left: 4px solid #60a5fa;
  }

  .toast-icon {
    font-size: 1.2rem;
    flex-shrink: 0;
  }

  .toast-message {
    flex: 1;
    font-weight: 500;
  }

  .toast-close {
    background: none;
    border: none;
    color: inherit;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s ease;
    flex-shrink: 0;
  }

  .toast-close:hover {
    background-color: rgba(255, 255, 255, 0.2);
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .toast-container {
      top: 10px;
      right: 10px;
      left: 10px;
    }

    .toast {
      min-width: auto;
      max-width: none;
      width: 100%;
    }
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .extractor-container {
      padding: 1.5rem;
    }

    .upload-area {
      padding: 2rem 1rem;
    }

    .upload-icon {
      font-size: 2rem;
    }

    .page-title {
      font-size: 2rem;
    }

    .file-list-header {
      flex-direction: column;
      align-items: stretch;
      gap: 1rem;
    }

    .file-actions {
      justify-content: center;
      flex-wrap: wrap;
    }

    .settings-grid {
      grid-template-columns: 1fr;
    }

    .instructions-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .format-support {
      justify-content: center;
    }
  }
</style>
